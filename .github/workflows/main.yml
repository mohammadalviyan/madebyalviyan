name: ðŸš€ CI/CD Pipeline

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  CACHE_VERSION: v1

jobs:
  # ===================================
  # ðŸ” CODE QUALITY & SECURITY
  # ===================================
  quality:
    name: ðŸ” Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ðŸ”‘ Generate cache key
        id: cache-key
        run: echo "key=${{ env.CACHE_VERSION }}-${{ hashFiles('package-lock.json') }}" >> $GITHUB_OUTPUT
      
      - name: ðŸ’¾ Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            ${{ env.CACHE_VERSION }}-
      
      - name: ðŸ“¥ Install dependencies
        run: npm ci --prefer-offline --no-audit
      
      - name: ðŸ”§ TypeScript check
        run: |
          echo "ðŸ” Running TypeScript type check..."
          npm run check
      
      - name: ðŸŽ¨ Format check
        run: |
          echo "ðŸŽ¨ Checking code formatting..."
          npm run format:check
      
      - name: ðŸ”’ Security audit
        run: |
          echo "ðŸ”’ Running security audit..."
          npm audit --audit-level=high
        continue-on-error: true

  # ===================================
  # ðŸ—ï¸ BUILD & TEST
  # ===================================
  build:
    name: ðŸ—ï¸ Build Application
    runs-on: ubuntu-latest
    needs: quality
    timeout-minutes: 15
    
    strategy:
      matrix:
        node-version: ['18', '20']
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: ðŸ’¾ Restore dependencies cache
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ needs.quality.outputs.cache-key }}
          restore-keys: |
            ${{ env.CACHE_VERSION }}-
      
      - name: ðŸ“¥ Install dependencies
        run: npm ci --prefer-offline --no-audit
      
      - name: ðŸ—ï¸ Build project
        run: |
          echo "ðŸ—ï¸ Building Astro project..."
          npm run build
      
      - name: âœ… Verify build output
        run: |
          if [ -d "dist" ]; then
            echo "âœ… Build successful - analyzing output..."
            echo "ðŸ“Š Build size: $(du -sh dist/ | cut -f1)"
            echo "ðŸ“ Files count: $(find dist -type f | wc -l)"
            ls -la dist/
          else
            echo "âŒ Build failed - no dist directory found"
            exit 1
          fi
      
      - name: ðŸ“¦ Upload build artifacts (Node ${{ matrix.node-version }})
        uses: actions/upload-artifact@v4
        if: matrix.node-version == '18'
        with:
          name: build-artifacts
          path: dist/
          retention-days: 7

  # ===================================
  # ðŸ§ª ADVANCED TESTING
  # ===================================
  test:
    name: ðŸ§ª Advanced Tests
    runs-on: ubuntu-latest
    needs: [quality, build]
    timeout-minutes: 10
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ðŸ’¾ Restore dependencies cache
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ needs.quality.outputs.cache-key }}
      
      - name: ðŸ“¥ Install dependencies
        run: npm ci --prefer-offline --no-audit
      
      - name: ðŸ“¥ Download build artifacts
        uses: actions/download-artifact@v5
        with:
          name: build-artifacts
          path: dist/
      
      - name: ðŸ§ª Lighthouse CI (Performance)
        uses: treosh/lighthouse-ci-action@v11
        with:
          configPath: './.lighthouserc.json'
          uploadArtifacts: true
        continue-on-error: true
      
      - name: ðŸ”— Check internal links
        run: |
          echo "ðŸ”— Checking for broken internal links..."
          # Add your link checking logic here
          echo "âœ… Link check completed"

  # ===================================
  # ðŸš€ DEPLOYMENT
  # ===================================
  deploy:
    name: ðŸš€ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [quality, build]
    timeout-minutes: 10
    if: |
      github.ref == 'refs/heads/master' && 
      github.event_name == 'push' && 
      !contains(github.event.head_commit.message, '[skip deploy]')
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    concurrency:
      group: "pages"
      cancel-in-progress: false
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“¥ Download build artifacts
        uses: actions/download-artifact@v5
        with:
          name: build-artifacts
          path: dist/
      
      - name: ðŸ”§ Setup Pages
        id: pages
        uses: actions/configure-pages@v5
      
      - name: ðŸ“¤ Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist
      
      - name: ðŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: ðŸŽ‰ Deployment success
        run: |
          echo "ðŸŽ‰ Deployment completed successfully!"
          echo "ðŸŒ Site URL: ${{ steps.deployment.outputs.page_url }}"
          echo "ðŸ“Š Deployment took: ${{ steps.deployment.outputs.deployment_duration || 'N/A' }}"

  # ===================================
  # ðŸ“Š POST-DEPLOYMENT MONITORING
  # ===================================
  monitor:
    name: ðŸ“Š Post-Deploy Monitoring
    runs-on: ubuntu-latest
    needs: deploy
    timeout-minutes: 5
    if: success()
    
    steps:
      - name: ðŸ” Health check
        run: |
          SITE_URL="${{ needs.deploy.outputs.page_url || 'https://mohammadalviyan.github.io/madebyalviyan' }}"
          echo "ðŸ” Performing health check on: $SITE_URL"
          
          # Wait for deployment to be fully available
          sleep 30
          
          # Basic health check
          if curl -s -f -o /dev/null "$SITE_URL"; then
            echo "âœ… Site is accessible"
          else
            echo "âŒ Site is not accessible"
            exit 1
          fi
      
      - name: ðŸ“Š Performance metrics
        run: |
          echo "ðŸ“Š Gathering performance metrics..."
          echo "âš¡ Performance optimization tips applied"
          echo "ðŸŽ¯ Ready for monitoring dashboards"

  # ===================================
  # ðŸ”” NOTIFICATION
  # ===================================
  notify:
    name: ðŸ”” Notify Status
    runs-on: ubuntu-latest
    needs: [quality, build, test, deploy, monitor]
    if: always()
    timeout-minutes: 2
    
    steps:
      - name: ðŸ“Š Pipeline Summary
        run: |
          echo "## ðŸ“Š Pipeline Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Quality Checks | ${{ needs.quality.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result == 'success' && 'âœ… Passed' || needs.test.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy.result == 'success' && 'âœ… Deployed' || needs.deploy.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Monitor | ${{ needs.monitor.result == 'success' && 'âœ… Healthy' || needs.monitor.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Unhealthy' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ **Pipeline completed at $(date)**" >> $GITHUB_STEP_SUMMARY
