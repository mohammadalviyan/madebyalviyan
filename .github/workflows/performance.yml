name: ðŸŽ¯ Performance & Quality Monitoring

on:
  schedule:
    # Run performance tests daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of performance test'
        required: true
        default: 'full'
        type: choice
        options:
        - 'full'
        - 'lighthouse'
        - 'bundle-analysis'

env:
  NODE_VERSION: '18'

jobs:
  # ===================================
  # ðŸ” LIGHTHOUSE PERFORMANCE AUDIT
  # ===================================
  lighthouse-audit:
    name: ðŸ” Lighthouse Performance Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event.inputs.test_type == 'full' || github.event.inputs.test_type == 'lighthouse' || github.event_name == 'schedule'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ðŸ“¥ Install dependencies
        run: npm ci --prefer-offline --no-audit
      
      - name: ðŸ—ï¸ Build for production
        run: npm run build
      
      - name: ðŸ” Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v12
        with:
          configPath: './.lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
      
      - name: ðŸ“Š Performance Summary
        run: |
          echo "## ðŸŽ¯ Lighthouse Performance Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… **Date**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Report**: Check Lighthouse CI results above" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Key Metrics Tracked:" >> $GITHUB_STEP_SUMMARY
          echo "- âš¡ Performance Score (Target: >80)" >> $GITHUB_STEP_SUMMARY
          echo "- â™¿ Accessibility Score (Target: >90)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” SEO Score (Target: >90)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Best Practices Score (Target: >85)" >> $GITHUB_STEP_SUMMARY

  # ===================================
  # ðŸ“¦ BUNDLE SIZE ANALYSIS
  # ===================================
  bundle-analysis:
    name: ðŸ“¦ Bundle Size Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event.inputs.test_type == 'full' || github.event.inputs.test_type == 'bundle-analysis' || github.event_name == 'schedule'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ðŸ“¥ Install dependencies
        run: npm ci --prefer-offline --no-audit
      
      - name: ðŸ—ï¸ Build for analysis
        run: npm run build
      
      - name: ðŸ“Š Analyze bundle size
        run: |
          echo "ðŸ“¦ Bundle Size Analysis Report" >> $GITHUB_STEP_SUMMARY
          echo "================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get total build size
          TOTAL_SIZE=$(du -sh dist/ | cut -f1)
          echo "ðŸ“¦ **Total Build Size**: $TOTAL_SIZE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Analyze individual files
          echo "### ðŸ“ File Breakdown:" >> $GITHUB_STEP_SUMMARY
          echo "| File | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          
          # Find largest files
          find dist -name "*.js" -o -name "*.css" -o -name "*.html" | head -10 | while read file; do
            size=$(du -h "$file" | cut -f1)
            filename=$(basename "$file")
            echo "| $filename | $size |" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Optimization Recommendations:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ—œï¸ Consider code splitting for large bundles" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ–¼ï¸ Optimize images with modern formats (WebP, AVIF)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ Enable gzip/brotli compression" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”„ Implement lazy loading for non-critical resources" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ“¤ Upload bundle analysis
        uses: actions/upload-artifact@v4
        with:
          name: bundle-analysis
          path: |
            dist/
            package.json
          retention-days: 7

  # ===================================
  # ðŸ”§ ACCESSIBILITY AUDIT
  # ===================================
  accessibility-audit:
    name: â™¿ Accessibility Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'schedule'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ðŸ“¥ Install dependencies
        run: npm ci --prefer-offline --no-audit
      
      - name: ðŸ—ï¸ Build for testing
        run: npm run build
      
      - name: â™¿ Run accessibility tests
        run: |
          echo "â™¿ Accessibility Audit Report" >> $GITHUB_STEP_SUMMARY
          echo "============================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… **Audit Date**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Accessibility Checklist:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ–¼ï¸ Alt text for images" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ¨ Color contrast ratios" >> $GITHUB_STEP_SUMMARY
          echo "- âŒ¨ï¸ Keyboard navigation" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“± Screen reader compatibility" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ·ï¸ Semantic HTML structure" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **Next Steps**: Review Lighthouse accessibility score for detailed recommendations" >> $GITHUB_STEP_SUMMARY

  # ===================================
  # ðŸ“Š PERFORMANCE MONITORING
  # ===================================
  performance-monitoring:
    name: ðŸ“Š Performance Monitoring
    runs-on: ubuntu-latest
    needs: [lighthouse-audit, bundle-analysis]
    timeout-minutes: 5
    if: always()
    
    steps:
      - name: ðŸ“Š Generate monitoring report
        run: |
          echo "# ðŸ“Š Daily Performance Monitoring Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Generated**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Audit Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Audit Type | Status | Notes |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lighthouse | ${{ needs.lighthouse-audit.result == 'success' && 'âœ… Passed' || needs.lighthouse-audit.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} | Performance, A11y, SEO, Best Practices |" >> $GITHUB_STEP_SUMMARY
          echo "| Bundle Analysis | ${{ needs.bundle-analysis.result == 'success' && 'âœ… Completed' || needs.bundle-analysis.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} | Size optimization analysis |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŽ¯ Performance Goals" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš€ **Performance**: >80 (Lighthouse)" >> $GITHUB_STEP_SUMMARY
          echo "- â™¿ **Accessibility**: >90 (Lighthouse)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” **SEO**: >90 (Lighthouse)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ **Bundle Size**: <500KB (Total)" >> $GITHUB_STEP_SUMMARY
          echo "- âš¡ **First Paint**: <1.5s" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”§ Optimization Opportunities" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. ðŸ–¼ï¸ **Image Optimization**: Use modern formats (WebP, AVIF)" >> $GITHUB_STEP_SUMMARY
          echo "2. ðŸ“¦ **Code Splitting**: Implement dynamic imports" >> $GITHUB_STEP_SUMMARY
          echo "3. ðŸ—œï¸ **Compression**: Enable gzip/brotli at server level" >> $GITHUB_STEP_SUMMARY
          echo "4. ðŸ”„ **Caching**: Optimize browser caching strategies" >> $GITHUB_STEP_SUMMARY
          echo "5. âš¡ **Loading**: Implement lazy loading and preloading" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Automated performance monitoring â€¢ Next run: Tomorrow at 2 AM UTC*" >> $GITHUB_STEP_SUMMARY
